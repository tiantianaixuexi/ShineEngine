# ShineEngine Tick 系统改进任务书

## 项目概述

**项目名称**: Tick 系统引擎级改进与 WASM 支持
**项目目标**: 将现有的 Tick 系统提升至商业引擎级别，并完善 WebAssembly 支持
**预计工期**: 10-12 周
**优先级**: 高

---

## 一、现状评估

### 1.1 当前系统优势
- ✅ 清晰的分层执行架构（PrePhysics → Physics → PostPhysics → Late）
- ✅ 基于 Kahn 算法的依赖管理，执行顺序正确
- ✅ 基础的 Tick 间隔和开关控制
- ✅ 轻量级封装，使用函数指针解耦

### 1.2 核心问题
- ❌ 单线程串行执行，无法利用多核 CPU
- ❌ 缺少性能分析工具，难以定位瓶颈
- ❌ 组件 Tick 需要手动管理，容易内存泄漏
- ❌ WASM 环境下间接调用开销大
- ❌ 缺少固定时间步长支持，物理模拟不稳定
- ❌ 缺少优先级系统，无法精细控制执行顺序

---

## 二、改进任务清单

### 阶段一：核心架构改进（3周）

#### 任务 1.1：固定时间步长系统 ⚠️ 高优先级

**目标**: 实现物理模拟所需的固定时间步长，保证确定性和稳定性

**技术要点**:
- 将 Tick 系统拆分为 Fixed Update（物理相关）和 Variable Update（渲染/逻辑相关）
- 实现累积时间器（Accumulator）模式
- 在一次渲染帧中可能执行多次物理 Tick

**实现文件**:
- `src/gameplay/tick/tick_types.h` - 添加 ETickUpdateMode 枚举
- `src/gameplay/tick/tickManager.h` - 添加固定时间步长支持

**验收标准**:
- [ ] 物理相关 Group（PrePhysics, Physics）使用固定时间步长
- [ ] 渲染相关 Group（PostPhysics, Late）使用可变时间步长
- [ ] 累积时间器正确处理帧率波动
- [ ] 单元测试覆盖各种帧率场景

**预计工时**: 5 天

---

#### 任务 1.2：组件 Tick 自动化 ⚠️ 高优先级

**目标**: 自动管理组件的 Tick 注册和注销，防止内存泄漏

**技术要点**:
- 在 UComponent 析构函数中自动注销 Tick
- 提供 RegisterTick/UnregisterTick 辅助方法
- 支持条件 Tick（ShouldTick）

**实现文件**:
- `src/gameplay/component/component.h` - 添加 Tick 自动管理
- `src/gameplay/tick/TickenableComponent.h` - 简化接口

**验收标准**:
- [ ] 组件销毁时自动注销 Tick
- [ ] 提供 ShouldTick 虚函数支持条件 Tick
- [ ] 内存泄漏检测通过
- [ ] 现有组件无需修改即可使用

**预计工时**: 3 天

---

#### 任务 1.3：性能分析工具 ⚠️ 高优先级

**目标**: 提供 Tick 函数执行时间统计，识别性能瓶颈

**技术要点**:
- 为 TickFunction 添加性能统计字段
- 实现高性能计时器（WASM 兼容）
- 提供性能报告接口

**实现文件**:
- `src/gameplay/tick/tick_function.h` - 添加性能统计字段
- `src/gameplay/tick/tick_profiler.h` - 新建性能分析器
- `src/util/timer.h` - 跨平台高精度计时器

**验收标准**:
- [ ] 统计每个 Tick 的执行时间（最小/最大/平均）
- [ ] 识别 Top 10 最慢的 Tick
- [ ] WASM 环境下使用 emscripten_get_now()
- [ ] 原生环境使用 std::chrono
- [ ] 性能开销 < 1%

**预计工时**: 4 天

---

### 阶段二：多线程支持（4周）

#### 任务 2.1：线程池实现 ⚠️ 高优先级

**目标**: 实现可配置的线程池，支持并行执行 Tick

**技术要点**:
- 支持配置线程数量（默认：硬件并发数）
- 实现任务队列和任务调度
- 支持线程亲和性和负载均衡
- WASM 环境下单线程回退

**实现文件**:
- `src/core/thread_pool.h` - 新建线程池
- `src/core/task.h` - 任务抽象
- `src/gameplay/tick/tick_parallel_executor.h` - 并行执行器

**验收标准**:
- [ ] 线程池正确启动和关闭
- [ ] 任务正确分发和执行
- [ ] 支持动态调整线程数量
- [ ] WASM 环境下回退到单线程
- [ ] 无数据竞争和死锁

**预计工时**: 7 天

---

#### 任务 2.2：并行执行策略 ⚠️ 高优先级

**目标**: 基于依赖图实现并行执行，利用多核性能

**技术要点**:
- 识别无依赖的 Tick（入度为 0）
- 组内并行执行无依赖的 Tick
- 组间并行执行（PrePhysics → Physics → PostPhysics → Late）
- 依赖感知的任务调度

**实现文件**:
- `src/gameplay/tick/tickManager.h` - 添加并行执行方法
- `src/gameplay/tick/parallel_scheduler.h` - 并行调度器

**验收标准**:
- [ ] 无依赖的 Tick 并行执行
- [ ] 依赖关系正确保证
- [ ] 性能提升 > 2x（4 核 CPU）
- [ ] 支持 1000+ Tick 函数
- [ ] 单元测试覆盖各种依赖场景

**预计工时**: 8 天

---

#### 任务 2.3：线程安全机制 ⚠️ 高优先级

**目标**: 确保多线程环境下的数据安全

**技术要点**:
- TickFunction 的线程安全访问
- 共享数据的同步原语（Mutex, Atomic）
- 避免数据竞争
- 细粒度锁优化

**实现文件**:
- `src/gameplay/tick/tick_function.h` - 添加线程安全访问
- `src/core/sync.h` - 同步原语封装

**验收标准**:
- [ ] ThreadSanitizer 检查通过
- [ ] 无数据竞争
- [ ] 无死锁
- [ ] 锁竞争开销 < 5%

**预计工时**: 5 天

---

#### 任务 2.4：WASM 单线程回退 ⚠️ 高优先级

**目标**: WASM 环境下回退到单线程模式

**技术要点**:
- 条件编译宏（#ifdef __EMSCRIPTEN__）
- 单线程执行路径
- 保持 API 兼容性

**实现文件**: 
- `src/shine_define.h` - 添加 WASM 宏 SHINE_PLATFORM_WASM
- `src/gameplay/tick/tickManager.h` - 条件编译

**验收标准**:
- [ ] WASM 环境下正确编译
- [ ] 单线程模式功能完整
- [ ] API 与多线程模式一致
- [ ] 浏览器中正常运行

**预计工时**: 2 天

---

### 阶段三：功能增强（3周）

#### 任务 3.1：Tick 优先级系统 ⚠️ 中优先级

**目标**: 支持优先级调度，精细控制执行顺序

**技术要点**:
- 定义 ETickPriority 枚举（VeryLow ~ Critical）
- 在 Kahn 算法中引入优先级
- 同 indegree 的节点按优先级排序
- 支持动态优先级调整

**实现文件**:
- `src/gameplay/tick/tick_types.h` - 添加优先级枚举
- `src/gameplay/tick/tick_function.h` - 添加优先级字段
- `src/gameplay/tick/tickManager.h` - 优先级调度

**验收标准**:
- [ ] 优先级正确影响执行顺序
- [ ] 支持 6 级优先级
- [ ] 动态调整优先级生效
- [ ] 单元测试覆盖各种优先级场景

**预计工时**: 4 天

---

#### 任务 3.2：全局/局部暂停机制 ⚠️ 中优先级

**目标**: 支持全局和分组级别的暂停控制

**技术要点**:
- 实现全局暂停（SetGlobalPause）
- 实现分组暂停（SetGroupPause）
- 暂停状态查询接口

**实现文件**:
- `src/gameplay/tick/tickManager.h` - 添加暂停控制

**验收标准**:
- [ ] 全局暂停正确阻止所有 Tick
- [ ] 分组暂停只影响指定分组
- [ ] 暂停状态查询准确
- [ ] 暂停/恢复无性能开销

**预计工时**: 2 天

---

#### 任务 3.3：依赖系统增强 ⚠️ 中优先级

**目标**: 支持强弱依赖和循环依赖检测

**技术要点**:
- 定义 EDependencyType（Strong/Weak）
- 实现循环依赖检测
- 提供详细的循环依赖报告

**实现文件**:
- `src/gameplay/tick/tick_types.h` - 添加依赖类型枚举
- `src/gameplay/tick/tick_function.h` - 使用 TickDependency
- `src/gameplay/tick/tickManager.h` - 循环依赖检测

**验收标准**:
- [ ] 强依赖正确保证执行顺序
- [ ] 弱依赖不阻塞执行
- [ ] 循环依赖正确检测
- [ ] 提供详细的循环依赖信息

**预计工时**: 5 天

---

#### 任务 3.4：Tick 世界隔离 ⚠️ 中优先级

**目标**: 支持多个独立的 Tick 世界

**技术要点**:
- 实现 TickContext（独立的 TickManager）
- 实现 TickWorld（管理多个 Context）
- 支持编辑器/游戏模式分离

**实现文件**:
- `src/gameplay/tick/tick_context.h` - 新建
- `src/gameplay/tick/tick_world.h` - 新建

**验收标准**:
- [ ] 支持创建多个独立 Context
- [ ] Context 之间互不影响
- [ ] 支持编辑器/游戏模式分离
- [ ] 内存正确释放

**预计工时**: 4 天

---

### 阶段四：WASM 优化（2周）

#### 任务 4.1：减少间接调用开销 ⚠️ 高优先级

**目标**: 减少 WASM 环境下的函数指针调用开销

**技术要点**:
- 实现批处理模式（Batching）
- 提供 Manager 类范例（BulletManager）
- 减少虚函数调用

**实现文件**:
- `src/gameplay/tick/tick_batch.h` - 批处理执行器
- `examples/bullet_manager.h` - Manager 范例

**验收标准**:
- [ ] 批处理模式减少间接调用 > 90%
- [ ] 提供 BulletManager 范例
- [ ] 性能提升 > 3x（WASM 环境）
- [ ] API 简单易用

**预计工时**: 5 天

---

#### 任务 4.2：内存管理优化 ⚠️ 中优先级

**目标**: WASM 环境下优化内存布局和分配

**技术要点**:
- 使用对象池（Object Pool）分配 TickFunction
- 优化数据布局（固定大小数组替代 vector）
- 减少内存碎片

**实现文件**:
- `src/core/object_pool.h` - 对象池
- `src/gameplay/tick/tick_function.h` - 优化数据布局

**验收标准**:
- [ ] 对象池正确管理内存
- [ ] 内存碎片减少 > 50%
- [ ] 分配/释放开销 < 1 μs
- [ ] 支持 1024+ TickFunction

**预计工时**: 4 天

---

#### 任务 4.3：WASM 编译配置 ⚠️ 高优先级

**目标**: 提供完整的 WASM 编译配置

**技术要点**:
- CMake 配置（条件编译、优化选项）
- 编译脚本（单线程/多线程版本）
- 性能测试脚本

**实现文件**:
- `CMakeLists.txt` - WASM 配置
- `scripts/build_wasm.sh` - 编译脚本
- `scripts/test_wasm_performance.sh` - 性能测试

**验收标准**:
- [ ] 单线程版本正确编译
- [ ] 多线程版本正确编译（可选）
- [ ] SIMD 优化启用
- [ ] 性能测试通过

**预计工时**: 3 天

---

#### 任务 4.4：计时器兼容 ⚠️ 中优先级

**目标**: 提供跨平台的高精度计时器

**技术要点**:
- WASM 环境使用 emscripten_get_now()
- 原生环境使用 std::chrono
- 统一接口封装

**实现文件**:
- `src/util/timer.h` - 高精度计时器

**验收标准**:
- [ ] WASM 环境下精度 < 1ms
- [ ] 原生环境下精度 < 0.1ms
- [ ] 性能开销 < 0.1 μs
- [ ] 单元测试通过

**预计工时**: 2 天

---

### 阶段五：测试与文档（1-2周）

#### 任务 5.1：单元测试 ⚠️ 中优先级

**目标**: 全面测试 Tick 系统功能

**测试范围**:
- TickManager 核心功能
- 依赖系统（包括循环依赖）
- 多线程执行
- 性能统计
- WASM 兼容性

**实现文件**:
- `tests/tick/tick_manager_test.cpp`
- `tests/tick/dependency_test.cpp`
- `tests/tick/multithread_test.cpp`
- `tests/tick/profiler_test.cpp`

**验收标准**:
- [ ] 单元测试覆盖率 > 80%
- [ ] 所有测试通过
- [ ] 无内存泄漏
- [ ] ThreadSanitizer 检查通过

**预计工时**: 5 天

---

#### 任务 5.2：集成测试 ⚠️ 中优先级

**目标**: 测试真实场景下的 Tick 系统

**测试场景**:
- 1000+ 组件 Tick
- 复杂依赖关系
- 性能压力测试
- WASM 环境测试

**实现文件**:
- `tests/integration/tick_stress_test.cpp`
- `tests/integration/wasm_test.cpp`

**验收标准**:
- [ ] 1000+ Tick 函数稳定运行
- [ ] 性能指标达标
- [ ] WASM 环境下功能完整
- [ ] 无崩溃和死锁

**预计工时**: 3 天

---

#### 任务 5.3：文档编写 ⚠️ 中优先级

**目标**: 提供完整的 API 文档和使用指南

**文档内容**:
- API 文档（Doxygen）
- 使用指南
- 性能优化指南
- WASM 部署指南

**实现文件**:
- `docs/api/tick_system.md`
- `docs/guides/tick_usage.md`
- `docs/guides/performance_optimization.md`
- `docs/guides/wasm_deployment.md`

**验收标准**:
- [ ] API 文档完整
- [ ] 使用指南清晰
- [ ] 包含代码示例
- [ ] 性能优化指南实用

**预计工时**: 4 天

---

## 三、依赖关系

```
阶段一（核心架构）
├── 任务 1.1: 固定时间步长
├── 任务 1.2: 组件 Tick 自动化
└── 任务 1.3: 性能分析工具

阶段二（多线程支持）
├── 任务 2.1: 线程池实现
├── 任务 2.2: 并行执行策略（依赖 2.1）
├── 任务 2.3: 线程安全机制（依赖 2.2）
└── 任务 2.4: WASM 单线程回退（依赖 2.2）

阶段三（功能增强）
├── 任务 3.1: Tick 优先级系统（依赖 1.3）
├── 任务 3.2: 全局/局部暂停机制
├── 任务 3.3: 依赖系统增强
└── 任务 3.4: Tick 世界隔离

阶段四（WASM 优化）
├── 任务 4.1: 减少间接调用开销（依赖 2.4）
├── 任务 4.2: 内存管理优化
├── 任务 4.3: WASM 编译配置
└── 任务 4.4: 计时器兼容

阶段五（测试与文档）
├── 任务 5.1: 单元测试（依赖所有实现）
├── 任务 5.2: 集成测试（依赖 5.1）
└── 任务 5.3: 文档编写
```

---

## 四、里程碑

| 里程碑 | 时间 | 交付物 |
|--------|------|--------|
| M1: 核心架构完成 | 第 3 周 | 固定时间步长、组件自动化、性能分析工具 |
| M2: 多线程支持完成 | 第 7 周 | 线程池、并行执行、线程安全、WASM 回退 |
| M3: 功能增强完成 | 第 10 周 | 优先级系统、暂停机制、依赖增强、世界隔离 |
| M4: WASM 优化完成 | 第 12 周 | 批处理、内存优化、编译配置、计时器 |
| M5: 测试与文档完成 | 第 14 周 | 单元测试、集成测试、完整文档 |

---

## 五、风险与应对

### 5.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 多线程数据竞争 | 高 | 中 | 使用 ThreadSanitizer，细粒度锁 |
| WASM 性能不达标 | 高 | 中 | 批处理优化，减少间接调用 |
| 循环依赖检测复杂 | 中 | 低 | 限制依赖深度，提供可视化工具 |
| 内存泄漏 | 高 | 低 | 使用 Valgrind/AddressSanitizer |

### 5.2 进度风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 任务延期 | 中 | 中 | 预留缓冲时间，优先级调整 |
| 依赖阻塞 | 高 | 低 | 并行开发，接口先行 |
| 测试不充分 | 高 | 中 | 持续集成，自动化测试 |

---

## 六、性能指标

### 6.1 目标性能

| 指标 | 原生平台 | WASM 平台 | 当前状态 |
|------|---------|-----------|----------|
| Tick 函数执行开销 | < 0.1 μs | < 0.5 μs | ~0.5 μs |
| 1000 个 Tick 函数执行时间 | < 1 ms | < 5 ms | ~10 ms |
| 依赖解析时间 | < 0.1 ms | < 0.5 ms | ~0.5 ms |
| 内存占用 | < 1 MB | < 2 MB | ~0.5 MB |
| 多线程加速比（4 核） | > 3x | N/A | 1x |

### 6.2 性能测试方法

```cpp
// 基准测试场景
1. 创建 1000 个无依赖的 Tick 函数
2. 每个函数执行简单计算（100 次浮点运算）
3. 测量总执行时间
4. 对比单线程和多线程性能
5. 对比原生和 WASM 性能
```

---

## 七、资源需求

### 7.1 人力资源

| 角色 | 人数 | 工作量 |
|------|------|--------|
| 核心开发 | 1-2 人 | 10-12 周 |
| 测试工程师 | 1 人 | 2-3 周 |
| 技术文档 | 1 人 | 1-2 周 |

### 7.2 硬件资源

- 开发机：多核 CPU（8 核+）、16GB+ 内存
- 测试机：多平台（Windows、Linux、macOS）
- WASM 测试：现代浏览器（Chrome、Firefox、Safari）

### 7.3 软件资源

- C++20 编译器（GCC 11+、Clang 13+、MSVC 19.3+）
- Emscripten SDK 3.1+
- CMake 3.20+
- 测试框架（Google Test、Catch2）
- 性能分析工具（Profiler、Valgrind、ThreadSanitizer）

---

## 八、验收标准

### 8.1 功能验收

- [ ] 所有功能任务完成
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过
- [ ] 无已知严重 Bug

### 8.2 性能验收

- [ ] 原生平台性能指标达标
- [ ] WASM 平台性能指标达标
- [ ] 多线程加速比 > 3x（4 核）
- [ ] 内存占用符合预期

### 8.3 质量验收

- [ ] 代码审查通过
- [ ] 静态分析无警告
- [ ] 内存泄漏检测通过
- [ ] 文档完整且准确

---

## 九、后续优化方向

### 9.1 短期优化（3-6 个月）

1. **ECS 集成** - 为高性能场景提供 Data-Oriented 批处理
2. **Job System** - 更通用的任务调度系统
3. **可视化工具** - 依赖图可视化、性能热力图

### 9.2 长期优化（6-12 个月）

1. **分布式 Tick** - 支持多机分布式执行
2. **AI 调度** - 基于机器学习的智能调度
3. **动态优化** - 运行时自动优化执行顺序

---

## 十、附录

### A. 参考文档

- `src/gameplay/tick/TickSystem_Analysis.md` - 原始分析文档
- `docs/tick_system_analysis.md` - 详细技术方案
- Unreal Engine 5 Tick System - 商业引擎参考
- Unity Job System - 并行任务系统参考

### B. 术语表

| 术语 | 说明 |
|------|------|
| Tick | 游戏循环中的更新函数 |
| Tick Group | Tick 的执行分组（PrePhysics、Physics 等） |
| Tick Function | Tick 的封装结构 |
| Fixed Timestep | 固定时间步长，用于物理模拟 |
| Variable Timestep | 可变时间步长，用于渲染和逻辑 |
| Dependency Graph | 依赖图，描述 Tick 之间的依赖关系 |
| Kahn Algorithm | 拓扑排序算法，用于构建执行顺序 |
| WASM | WebAssembly，Web 平台的二进制指令格式 |
| Indirect Call | 间接调用，通过函数指针调用函数 |

### C. 联系方式

- 项目负责人：[待定]
- 技术负责人：[待定]
- 测试负责人：[待定]

---

**文档版本**: 1.0
**创建日期**: 2025-12-29
**最后更新**: 2025-12-29
**状态**: 待审核
